{% extends "base/base.html" %}

{% block title %}订单确认 - 电子商务系统{% endblock %}

{% block css %}
<style>
    .checkout-title {
        font-size: 24px;
        margin: 20px 0;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
    }
    .checkout-container {
        display: flex;
        gap: 30px;
    }
    .order-items {
        flex: 2;
    }
    .order-summary {
        flex: 1;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        height: fit-content;
    }
    .items-title, .summary-title {
        font-size: 18px;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .order-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .order-table th, .order-table td {
        border: 1px solid #eee;
        padding: 12px;
        text-align: center;
    }
    .order-table th {
        background: #f5f5f5;
    }
    .order-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
    }
    .product-name {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .address-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    .address-title {
        font-size: 16px;
        margin-bottom: 10px;
        font-weight: bold;
    }
    .address-card {
        padding: 15px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .address-card.active {
        border-color: #008CBA;
        background: #f0f7ff;
    }
    .add-address {
        color: #008CBA;
        text-decoration: none;
        font-size: 14px;
    }
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
        font-size: 16px;
    }
    .total-amount {
        font-size: 18px;
        color: #e74c3c;
        font-weight: bold;
        padding-top: 10px;
        border-top: 1px solid #ddd;
        margin-top: 10px;
    }
    .pay-btn {
        width: 100%;
        padding: 15px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="checkout-title">订单确认</h1>

<div class="checkout-container">
    <!-- 订单商品 -->
    <div class="order-items">
        <h2 class="items-title">订单商品</h2>
        <table class="order-table">
            <thead>
                <tr>
                    <th>商品图片</th>
                    <th>商品名称</th>
                    <th>单价</th>
                    <th>数量</th>
                    <th>小计</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td><img src="/static/admin/uploads/products/{{ item.image }}" alt="{{ item.name }}" class="order-img"></td>
                    <td class="product-name">{{ item.name }}</td>
                    <td>¥{{ item.price }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>¥{{ item.subtotal }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 收货地址 -->
        <div class="address-section">
            <h2 class="address-title">收货地址</h2>
            <div class="address-card active">
                <p>收货人：{{ address.name }}</p>
                <p>手机号：{{ address.phone }}</p>
                <p>地址：{{ address.province }} {{ address.city }} {{ address.detail }}</p>
            </div>
            <a href="/profile/addresses" class="add-address">+ 新增/修改地址</a>
        </div>
    </div>

    <!-- 订单摘要 -->
    <div class="order-summary">
        <h2 class="summary-title">订单摘要</h2>
        <div class="summary-item">
            <span>商品总数</span>
            <span>{{ total_quantity }} 件</span>
        </div>
        <div class="summary-item">
            <span>商品总价</span>
            <span>¥{{ total_amount }}</span>
        </div>
        <div class="summary-item">
            <span>运费</span>
            <span>¥0.00（免运费）</span>
        </div>
        <div class="summary-item total-amount">
            <span>实付款</span>
            <span>¥{{ total_amount }}</span>
        </div>
        <button class="pay-btn" onclick="submitOrder()">提交订单</button>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    // 提交订单（调用后端下单接口）
    function submitOrder() {
        fetch('/api/purchase', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            alert(data.msg);
            if (data.success) {
                // 下单成功后跳转到订单列表页
                window.location.href = '/profile/orders';
            }
        })
        .catch(err => {
            console.error('下单失败：', err);
            alert('网络异常，下单失败，请重试！');
        });
    }
</script>
{% endblock %}