{% extends "base/base.html" %}

{% block title %}{{ product.name }} - å•†å“è¯¦æƒ…{% endblock %}

{% block css %}
<style>
    .product-detail-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }
    .product-img-wrapper {
        flex: 1;
        min-width: 300px;
    }
    .main-img {
        width: 100%;
        max-width: 500px;
        height: auto;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .product-info {
        flex: 1;
        min-width: 300px;
        padding: 20px 0;
    }
    .product-name {
        font-size: 24px;
        margin-bottom: 15px;
        color: #333;
        line-height: 1.3;
    }
    .product-price {
        font-size: 28px;
        color: #e74c3c;
        font-weight: bold;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    .product-stock {
        margin-bottom: 20px;
        color: #666;
        font-size: 14px;
    }
    .stock-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
    }
    .stock-available {
        background: #e8f5e9;
        color: #27ae60;
    }
    .stock-unavailable {
        background: #fce4ec;
        color: #e74c3c;
    }
    .product-desc {
        line-height: 1.8;
        color: #666;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }
    .operate-btns {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    .quantity-control {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }
    .quantity-btn {
        width: 36px;
        height: 36px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        border: none;
        outline: none;
    }
    .quantity-btn:hover {
        background: #eee;
    }
    .quantity-input {
        width: 60px;
        height: 36px;
        border: none;
        border-left: 1px solid #ddd;
        border-right: 1px solid #ddd;
        text-align: center;
        font-size: 16px;
        outline: none;
    }
    .add-cart-btn {
        padding: 12px 40px;
        background: #008CBA;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 500;
        flex: 1;
        min-width: 150px;
    }
    .add-cart-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.8;
    }
    .favorite-btn {
        padding: 12px 20px;
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 100px;
    }
    .favorite-btn.active {
        color: #e74c3c;
        border-color: #e74c3c;
        background: #fef0f3;
    }
    .section-title {
        font-size: 20px;
        margin: 40px 0 20px;
        padding-left: 20px;
        border-left: 4px solid #008CBA;
        color: #333;
    }
    .product-detail-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px 50px;
        line-height: 2;
        color: #555;
        font-size: 14px;
    }
    .icon-star {
        font-size: 18px;
    }
</style>
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="product-img-wrapper">
        <!-- å•†å“å›¾ç‰‡ï¼šå¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ï¼ˆç¡®ä¿default-product.pngå­˜åœ¨ï¼Œæˆ–æ›¿æ¢æˆä½ æœ‰çš„é»˜è®¤å›¾ï¼‰ -->
        <img src="/static/admin/uploads/products/{{ product.image|default('default-product.png') }}" 
             alt="{{ product.name|default('å•†å“å›¾ç‰‡') }}" 
             class="main-img">
    </div>
    <div class="product-info">
        <h1 class="product-name">{{ product.name|default('æœªçŸ¥å•†å“') }}</h1>
        <div class="product-price">Â¥{{ "%.2f"|format(product.price|default(0.00)) }}</div>
        <div class="product-stock">
            åº“å­˜ï¼š{{ product.stock|default(0) }} ä»¶
            <span class="stock-status 
                {% if product.stock|default(0) > 0 %}stock-available{% else %}stock-unavailable{% endif %}">
                {% if product.stock|default(0) > 0 %}æœ‰è´§{% else %}æ— è´§{% endif %}
            </span>
        </div>
        <div class="product-desc">
            {{ product.description|default('æš‚æ— å•†å“æè¿°') }}
        </div>
        <div class="operate-btns">
            <div class="quantity-control">
                <button class="quantity-btn" id="decreaseBtn">-</button>
                <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" 
                       max="{{ product.stock|default(1) }}">
                <button class="quantity-btn" id="increaseBtn">+</button>
            </div>
            <button class="add-cart-btn" id="addToCartBtn" 
                    {% if product.stock|default(0) <= 0 %}disabled{% endif %}>
                åŠ å…¥è´­ç‰©è½¦
            </button>
            <button class="favorite-btn {% if product.is_favorite|default(false) %}active{% endif %}" 
                    id="favoriteBtn">
                <span class="icon-star">
                    {% if product.is_favorite|default(false) %}â˜…{% else %}â˜†{% endif %}
                </span>
                <span id="favoriteText">
                    {% if product.is_favorite|default(false) %}å·²æ”¶è—{% else %}æ”¶è—{% endif %}
                </span>
            </button>
        </div>
    </div>
</div>

<h3 class="section-title">å•†å“è¯¦æƒ…</h3>
<div class="product-detail-content">
    {{ product.detail|default('æš‚æ— è¯¦ç»†ä»‹ç»') }}
</div>

<!-- æ•°æ®å­˜å‚¨åŒºåŸŸ - ç”¨äºJavaScriptè·å–æ•°æ® -->
<div id="productData" 
     data-product-id="{{ product.product_id|default(0) }}"
     data-product-stock="{{ product.stock|default(1) }}"
     data-is-favorite="{% if product.is_favorite|default(false) %}true{% else %}false{% endif %}">
</div>
{% endblock %}

{% block js %}
<script>
// ä»æ•°æ®å­˜å‚¨åŒºåŸŸè·å–äº§å“ä¿¡æ¯
const productDataElement = document.getElementById('productData');
const productId = parseInt(productDataElement.dataset.productId) || 0;
const maxStock = parseInt(productDataElement.dataset.productStock) || 1;
let isFavorite = productDataElement.dataset.isFavorite === 'true'; // åˆå§‹å€¼ï¼ˆåç»­ä¼šè¢«åç«¯çŠ¶æ€è¦†ç›–ï¼‰

// DOMå…ƒç´ å¼•ç”¨
const quantityInput = document.getElementById('quantityInput');
const decreaseBtn = document.getElementById('decreaseBtn');
const increaseBtn = document.getElementById('increaseBtn');
const addToCartBtn = document.getElementById('addToCartBtn');
const favoriteBtn = document.getElementById('favoriteBtn');
const favoriteText = document.getElementById('favoriteText');
const favoriteIcon = favoriteBtn.querySelector('.icon-star');

// æ•°é‡æ§åˆ¶åŠŸèƒ½ï¼ˆä¿ç•™ä½ åŸæœ‰é€»è¾‘ï¼‰
function setupQuantityControls() {
    decreaseBtn.addEventListener('click', function() {
        let current = parseInt(quantityInput.value);
        if (current > 1) {
            quantityInput.value = current - 1;
        }
    });

    increaseBtn.addEventListener('click', function() {
        let current = parseInt(quantityInput.value);
        if (current < maxStock) {
            quantityInput.value = current + 1;
        } else {
            alert('å·²è¾¾æœ€å¤§åº“å­˜ï¼');
        }
    });

    quantityInput.addEventListener('input', function() {
        let current = parseInt(this.value) || 1;
        if (current < 1) current = 1;
        if (current > maxStock) current = maxStock;
        this.value = current;
    });
}

// åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½ï¼ˆä¿ç•™ä½ åŸæœ‰é€»è¾‘ï¼‰
function setupAddToCart() {
    addToCartBtn.addEventListener('click', function() {
        const quantity = parseInt(quantityInput.value);
        
        // 1. åŸºç¡€æ ¡éªŒ
        if (productId <= 0) {
            alert('å•†å“ä¸å­˜åœ¨ï¼');
            return;
        }
        if (maxStock <= 0) {
            alert('å•†å“å·²æ— è´§ï¼');
            return;
        }
        if (quantity < 1 || quantity > maxStock) {
            alert(`è¯·é€‰æ‹©1-${maxStock}ä¹‹é—´çš„æ•°é‡ï¼`);
            return;
        }
        
        // 2. å‘é€è¯·æ±‚ï¼ˆAPIè·¯å¾„ä¿®æ­£ä¸ºåç«¯å®šä¹‰çš„ /api/add_to_cartï¼‰
        fetch('/api/add_to_cart', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,  // å‚æ•°åå’Œåç«¯ä¸€è‡´
                quantity: quantity      // å‚æ•°åå’Œåç«¯ä¸€è‡´
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`ç½‘ç»œé”™è¯¯ï¼š${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('åŠ å…¥è´­ç‰©è½¦æˆåŠŸï¼');
                // å¯é€‰ï¼šè·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // window.location.href = '/cart';
            } else {
                alert(`åŠ å…¥è´­ç‰©è½¦å¤±è´¥ï¼š${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
            }
        })
        .catch(error => {
            console.error('åŠ å…¥è´­ç‰©è½¦å¤±è´¥ï¼š', error);
            alert('åŠ å…¥è´­ç‰©è½¦å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
        });
    });
}

// ğŸ‘‰ æ–°å¢ï¼šåŒæ­¥åç«¯æ”¶è—çŠ¶æ€ï¼ˆè§£å†³â€œæ˜Ÿæ˜Ÿä¸å˜é»‘â€é—®é¢˜ï¼‰
function syncFavoriteStatus() {
    // å•†å“IDæ— æ•ˆæ—¶ï¼Œä¸å‘é€è¯·æ±‚
    if (productId <= 0) return;

    // è°ƒç”¨åç«¯æ–°å¢çš„â€œæ£€æŸ¥æ”¶è—çŠ¶æ€â€æ¥å£
    fetch(`/api/check_favorite?product_id=${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`ç½‘ç»œé”™è¯¯ï¼š${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // ç”¨åç«¯è¿”å›çš„çŠ¶æ€è¦†ç›–æœ¬åœ°åˆå§‹å€¼
                isFavorite = result.is_favorite;
                // æ ¹æ®çœŸå®çŠ¶æ€æ›´æ–°UI
                if (isFavorite) {
                    favoriteBtn.classList.add('active');
                    favoriteIcon.textContent = 'â˜…';
                    favoriteText.textContent = 'å·²æ”¶è—';
                } else {
                    favoriteBtn.classList.remove('active');
                    favoriteIcon.textContent = 'â˜†';
                    favoriteText.textContent = 'æ”¶è—';
                }
            } else {
                console.error('åŒæ­¥æ”¶è—çŠ¶æ€å¤±è´¥ï¼š', result.msg);
                // å¤±è´¥æ—¶ä¸å½±å“åŸæœ‰æ“ä½œï¼Œä»…æ‰“å°é”™è¯¯
            }
        })
        .catch(error => {
            console.error('åŒæ­¥æ”¶è—çŠ¶æ€å¼‚å¸¸ï¼š', error);
        });
}

// æ”¶è—åŠŸèƒ½ï¼ˆä¿ç•™ä½ åŸæœ‰ç‚¹å‡»é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function setupFavorite() {
    favoriteBtn.addEventListener('click', function() {
        // 1. æ ¡éªŒå•†å“ID
        if (productId <= 0) {
            alert('å•†å“ä¸å­˜åœ¨ï¼');
            return;
        }
        
        // 2. ç¡®å®šè¯·æ±‚APIï¼ˆæ ¹æ®å½“å‰æ”¶è—çŠ¶æ€ï¼‰
        const apiUrl = isFavorite ? '/api/remove_favorite' : '/api/add_favorite';
        
        // 3. å‘é€è¯·æ±‚ï¼ˆAPIè·¯å¾„ä¿®æ­£ä¸ºåç«¯å®šä¹‰çš„æ¥å£ï¼‰
        fetch(apiUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                product_id: productId  // å‚æ•°åå’Œåç«¯ä¸€è‡´
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`ç½‘ç»œé”™è¯¯ï¼š${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // åˆ‡æ¢æ”¶è—çŠ¶æ€å¹¶æ›´æ–°UI
                isFavorite = !isFavorite;
                if (isFavorite) {
                    favoriteBtn.classList.add('active');
                    favoriteIcon.textContent = 'â˜…';
                    favoriteText.textContent = 'å·²æ”¶è—';
                } else {
                    favoriteBtn.classList.remove('active');
                    favoriteIcon.textContent = 'â˜†';
                    favoriteText.textContent = 'æ”¶è—';
                }
                alert(data.msg || (isFavorite ? 'æ”¶è—æˆåŠŸï¼' : 'å–æ¶ˆæ”¶è—æˆåŠŸï¼'));
            } else {
                alert(`æ“ä½œå¤±è´¥ï¼š${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
            }
        })
        .catch(error => {
            console.error('æ”¶è—æ“ä½œå¤±è´¥ï¼š', error);
            alert('æ”¶è—æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
        });
    });
}

// åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½ï¼ˆæ–°å¢åŒæ­¥æ”¶è—çŠ¶æ€çš„è°ƒç”¨ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    setupQuantityControls();
    setupAddToCart();
    setupFavorite();
    syncFavoriteStatus(); // ğŸ‘‰ å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶åŒæ­¥åç«¯æ”¶è—çŠ¶æ€
});
</script>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/user/css/base.css">
<!-- æ–°å¢ä¸“å±è¯¦æƒ…é¡µCSSï¼ˆå•†å“å±•ç¤ºã€è§„æ ¼é€‰æ‹©æ ·å¼ï¼‰ -->
<link rel="stylesheet" href="/static/user/css/product_detail.css">
{% endblock %}

{% block js %}
<script src="/static/user/js/base.js"></script>
<!-- æ–°å¢ä¸“å±è¯¦æƒ…é¡µJS -->
<script src="/static/user/js/product_detail.js"></script>
{% endblock %}